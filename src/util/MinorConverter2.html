<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Major:MIDI → Virtual Piano 문자 악보 변환기</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
    }

    #output {
      white-space: pre-wrap;
      padding: 15px;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <h2>Minor:MIDI → Virtual Piano 문자 악보 변환기</h2>
  <input type="file" id="midi-file" accept=".mid,.midi">
  <pre id="output">MIDI 파일을 선택하세요...</pre>

  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi"></script>
  <script>
    const midiToVpKey = {
      "36": "1",
      "37": "!",
      "38": "2",
      "39": "3",
      "40": "#",
      "41": "4",
      "42": "$",
      "43": "5",
      "44": "6",
      "45": "^",
      "46": "7",
      "47": "&",
      "48": "8",
      "49": "*",
      "50": "9",
      "51": "0",
      "52": ")",
      "53": "q",
      "54": "Q",
      "55": "w",
      "56": "e",
      "57": "E",
      "58": "r",
      "59": "R",
      "60": "t",
      "61": "T",
      "62": "y",
      "63": "u",
      "64": "U",
      "65": "i",
      "66": "I",
      "67": "o",
      "68": "p",
      "69": "P",
      "70": "a",
      "71": "A",
      "72": "s",
      "73": "S",
      "74": "d",
      "75": "f",
      "76": "F",
      "77": "g",
      "78": "G",
      "79": "h",
      "80": "j",
      "81": "J",
      "82": "k",
      "83": "K",
      "84": "l",
      "85": "L",
      "86": "z",
      "87": "x",
      "88": "X",
      "89": "c",
      "90": "C",
      "91": "v",
      "92": "b",
      "93": "B",
      "94": "n",
      "95": "N",
      "96": "m",
      "97": "M"
    }

    const TIME_GAP_SCALE = 10;  // 시간 차이에 따른 공백 비율
    const MAX_LINE_WIDTH = 200; // 한 줄 최대 문자 길이

    document.getElementById('midi-file').addEventListener('change', async function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function (e) {
        const midi = new Midi(e.target.result);
        const events = [];

        // 모든 노트 수집
        midi.tracks.forEach(track => {
          track.notes.forEach(note => {
            const char = midiToVpKey[note.midi];
            if (char) events.push({ time: note.time, char });
          });
        });

        // 시간순 정렬
        events.sort((a, b) => a.time - b.time);

        // === 같은 시간대 노트 묶기 ===
        const grouped = [];
        let currentTime = null;
        let currentNotes = [];

        events.forEach(({ time, char }) => {
          if (currentTime === null) {
            currentTime = time;
            currentNotes = [char];
          } else if (Math.abs(time - currentTime) < 0.000001) {
            // 완전히 동일한 시간 → 같은 그룹에 추가
            currentNotes.push(char);
          } else {
            grouped.push({ time: currentTime, chars: currentNotes.sort().join('') });
            currentTime = time;
            currentNotes = [char];
          }
        });
        if (currentNotes.length) grouped.push({ time: currentTime, chars: currentNotes.sort().join('') });

        // === 출력 ===
        let outputHTML = '';
        let prevTime = 0;
        let lineWidth = 0;

        grouped.forEach(({ time, chars }) => {
          const gap = Math.round((time - prevTime) * TIME_GAP_SCALE);
          const totalWidth = gap + chars.length;

          // 줄 너비 초과 시 줄바꿈
          if (lineWidth + totalWidth > MAX_LINE_WIDTH) {
            outputHTML += '\n';
            lineWidth = 0;
          }

          outputHTML += '&nbsp;'.repeat(gap > 0 ? gap : 1) + chars;
          lineWidth += totalWidth;
          prevTime = time;
        });

        document.getElementById('output').innerHTML = outputHTML;
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>

</html>