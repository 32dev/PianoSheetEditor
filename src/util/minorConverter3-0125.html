<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>MIDI → Virtual Piano (0.125s Quantized)</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background-color: #f4f4f4;
        }

        #output {
            white-space: pre-wrap;
            background: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            line-height: 1.6;
            font-size: 14px;
            min-height: 200px;
        }
    </style>
</head>

<body>
    <h2>MIDI → Virtual Piano 변환기 (0.125초 간격 정렬)</h2>
    <input type="file" id="midi-file" accept=".mid,.midi">
    <hr>
    <div id="output">MIDI 파일을 선택하세요...</div>

    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi"></script>
    <script>
        const midiToVpKey = {
            "36": "1", "37": "!", "38": "2", "39": "3", "40": "#", "41": "4", "42": "$", "43": "5", "44": "6", "45": "^", "46": "7", "47": "&", "48": "8", "49": "*", "50": "9", "51": "0", "52": ")", "53": "q", "54": "Q", "55": "w", "56": "e", "57": "E", "58": "r", "59": "R", "60": "t", "61": "T", "62": "y", "63": "u", "64": "U", "65": "i", "66": "I", "67": "o", "68": "p", "69": "P", "70": "a", "71": "A", "72": "s", "73": "S", "74": "d", "75": "f", "76": "F", "77": "g", "78": "G", "79": "h", "80": "j", "81": "J", "82": "k", "83": "K", "84": "l", "85": "L", "86": "z", "87": "x", "88": "X", "89": "c", "90": "C", "91": "v", "92": "b", "93": "B", "94": "n", "95": "N", "96": "m", "97": "M"
        };

        const GRID_SIZE = 0.125; // 0.125초 간격으로 양자화
        const MAX_LINE_CHUNKS = 40; // 한 줄에 표시할 최대 박스(그리드) 수

        document.getElementById('midi-file').addEventListener('change', async function () {
            const file = this.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                const midi = new Midi(e.target.result);
                const gridMap = {}; // { gridIndex: [chars] }

                midi.tracks.forEach(track => {
                    track.notes.forEach(note => {
                        const char = midiToVpKey[note.midi];
                        if (char) {
                            // 0.125초 단위로 인덱스 계산 (양자화)
                            const gridIndex = Math.round(note.time / GRID_SIZE);
                            if (!gridMap[gridIndex]) gridMap[gridIndex] = [];
                            if (!gridMap[gridIndex].includes(char)) {
                                gridMap[gridIndex].push(char);
                            }
                        }
                    });
                });

                const sortedIndices = Object.keys(gridMap).map(Number).sort((a, b) => a - b);
                if (sortedIndices.length === 0) {
                    document.getElementById('output').innerText = "변환할 노트가 없습니다.";
                    return;
                }

                let outputText = '';
                let lastIndex = 0;
                let lineCount = 0;

                sortedIndices.forEach((index) => {
                    // 이전 노트와의 간격만큼 공백 추가
                    const gap = index - lastIndex;

                    for (let i = 0; i < gap; i++) {
                        outputText += ' ';
                        lineCount++;
                        // 일정 길이마다 줄바꿈
                        if (lineCount >= MAX_LINE_WIDTH_ADJUSTED(index)) {
                            // 실제 구현에선 단순히 글자수로 자르기보다 일정 간격으로 자르는게 깔끔함
                        }
                    }

                    // 화음 처리 (여러 음이면 [abc] 형식, 하나면 a 형식)
                    const chars = gridMap[index].sort().join('');
                    const noteStr = chars.length > 1 ? `[${chars}]` : chars;

                    outputText += noteStr;
                    lineCount += noteStr.length;

                    // 줄바꿈 로직 (너무 길어지면)
                    if (lineCount > 100) {
                        outputText += '\n';
                        lineCount = 0;
                    }

                    lastIndex = index;
                });

                // HTML의 &nbsp; 대신 <pre> 태그의 속성을 살려 텍스트로 삽입
                document.getElementById('output').innerText = outputText;
            };
            reader.readAsArrayBuffer(file);
        });

        function MAX_LINE_WIDTH_ADJUSTED(idx) {
            return 80; // 가독성을 위한 한 줄 길이
        }
    </script>
</body>

</html>